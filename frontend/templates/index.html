<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog App</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/loading-states.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="logo">Blog App</h1>
            <nav class="nav">
                <!-- <a href="/" class="nav-link">Home</a> -->
                <div id="auth-section">
                    <button id="login-btn" class="btn btn-primary" onclick="login()">Login</button>
                    <button id="logout-btn" class="btn btn-secondary" onclick="logout()" style="display: none;">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Admin Section (only visible to authors) -->
            <div id="admin-section" class="admin-section" style="display: none;">
                <div class="admin-actions">
                    <button class="btn btn-success" onclick="showNewPostForm()">New Post</button>
                </div>
            </div>

            <!-- Blog Posts Section -->
            <section class="posts-section">
                <h2>Latest Posts</h2>
                <div id="posts-container" class="posts-grid" hx-get="/posts/html" hx-trigger="load">
                    <!-- Posts will be loaded here via HTMX -->
                </div>
            </section>

            <!-- New Post Modal -->
            <div id="new-post-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Create New Post</h3>
                        <button class="close-btn" onclick="closeModal('new-post-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="new-post-form" hx-post="/admin/new" hx-target="#posts-container" hx-swap="beforeend">
                            <div class="form-group">
                                <label for="title">Title</label>
                                <input type="text" id="title" name="title" required class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="content">Content (Markdown)</label>
                                <textarea id="content" name="content" rows="10" required class="form-control"></textarea>
                            </div>
                            <div class="form-group">
                                <button type="button" onclick="previewContent()" class="btn btn-secondary">Preview</button>
                                <button type="submit" class="btn btn-success">Create Post</button>
                            </div>
                        </form>
                        <div id="preview-container" class="preview-container" style="display: none;">
                            <h4>Preview</h4>
                            <div id="preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Post Modal -->
            <div id="edit-post-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Post</h3>
                        <button class="close-btn" onclick="closeModal('edit-post-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-post-form">
                            <div class="form-group">
                                <label for="edit-title">Title</label>
                                <input type="text" id="edit-title" name="title" required class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="edit-content">Content (Markdown)</label>
                                <textarea id="edit-content" name="content" rows="10" required class="form-control"></textarea>
                            </div>
                            <div class="form-group">
                                <button type="button" onclick="previewEditContent()" class="btn btn-secondary">Preview</button>
                                <button type="submit" class="btn btn-success">Update Post</button>
                            </div>
                        </form>
                        <div id="edit-preview-container" class="preview-container" style="display: none;">
                            <h4>Preview</h4>
                            <div id="edit-preview-content"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Blog App. Built with Rust, Keycloak, and modern web technologies.</p>
        </div>
    </footer>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('auth_token');
        
        // Check for token in URL fragment on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkForTokenInUrl();
            checkAuthStatus();
        });
        
        // Function to check for token in URL fragment
        function checkForTokenInUrl() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;
            
            const params = new URLSearchParams(hash);
            const token = params.get('token');
            const accessToken = params.get('access_token');
            
            if (token) {
                // Store the token
                localStorage.setItem('auth_token', token);
                authToken = token;
                
                // Update UI
                updateAuthUI();
                
                // Clear the URL fragment
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Show success message
                alert('Successfully logged in!');
            }
        }

        // Authentication functions
        function login() {
            // Generate a random state parameter for CSRF protection
            const state = Math.random().toString(36).substring(2, 15) + 
                         Math.random().toString(36).substring(2, 15);
            
            // Store the state in session storage
            sessionStorage.setItem('oauth_state', state);
            
            // Redirect to the login endpoint
            window.location.href = `/auth/login?state=${state}`;
        }
        
        function logout() {
            // Clear authentication data first
            clearAuth();
            
            // Construct the logout URL with proper parameters
            const keycloakLogoutUrl = 'http://10.216.68.222:8080/realms/blog-realm/protocol/openid-connect/logout';
            const clientId = 'blog-client';
            const redirectUri = encodeURIComponent('http://10.216.68.222:80');
            
            // Redirect to Keycloak logout with all required parameters
            window.location.href = `${keycloakLogoutUrl}?client_id=${clientId}&post_logout_redirect_uri=${redirectUri}&id_token_hint=${encodeURIComponent(localStorage.getItem('id_token') || '')}`;
        }
        
        // Check authentication status
        function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                // Check if token is expired
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isExpired = payload.exp * 1000 < Date.now();
                    
                    if (isExpired) {
                        // Token is expired, clear it
                        clearAuth();
                        return;
                    }
                    
                    // Token is valid, update UI
                    currentUser = {
                        id: payload.sub,
                        roles: payload.roles || []
                    };
                    updateAuthUI();
                } catch (e) {
                    console.error('Error parsing token:', e);
                    clearAuth();
                }
            }
        }
        
        // Update authentication UI
        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminSection = document.getElementById('admin-section');
            
            if (authToken) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                
                // Show admin section if user has author role
                if (currentUser && currentUser.roles && currentUser.roles.includes('author')) {
                    adminSection.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                }
                
                // Add auth token to all HTMX requests
                document.body.addEventListener('htmx:configRequest', function(event) {
                    event.detail.headers['Authorization'] = `Bearer ${authToken}`;
                });
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                adminSection.style.display = 'none';
            }
        }
        
        // Clear authentication
        function clearAuth() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            currentUser = null;
            authToken = null;
            updateAuthUI();
        }

        // Handle authentication callback
        async function handleAuthCallback(code, state) {
            const storedState = sessionStorage.getItem('oauth_state');
            
            if (state !== storedState) {
                console.error('State mismatch');
                return;
            }
            
            try {
                // Exchange the authorization code for a token
                const response = await fetch(`/auth/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.token) {
                        authToken = data.token;
                        currentUser = data.user || { roles: [] };
                        
                        localStorage.setItem('auth_token', authToken);
                        localStorage.setItem('user_info', JSON.stringify(currentUser));
                        
                        updateAuthUI();
                        
                        // Clear the state from session storage
                        sessionStorage.removeItem('oauth_state');
                        
                        // Redirect to home page
                        window.location.href = '/';
                    }
                } else {
                    throw new Error('Failed to exchange code for token');
                }
            } catch (error) {
                console.error('Error during authentication:', error);
                clearAuth();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminSection = document.getElementById('admin-section');
            
            if (currentUser) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                
                if (currentUser.roles && currentUser.roles.includes('author')) {
                    adminSection.style.display = 'block';
                } else {
                    adminSection.style.display = 'none';
                }
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                adminSection.style.display = 'none';
            }
        }

        // Clear authentication
        function clearAuth() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            currentUser = null;
            authToken = null;
            updateAuthUI();
        }

        // Modal functions
        function showNewPostForm() {
            document.getElementById('new-post-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Preview functions
        async function previewContent() {
            const content = document.getElementById('content').value;
            if (!content.trim()) return;
            
            try {
                const response = await fetch('/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });
                
                const html = await response.text();
                document.getElementById('preview-content').innerHTML = html;
                document.getElementById('preview-container').style.display = 'block';
            } catch (error) {
                console.error('Error previewing content:', error);
            }
        }

        async function previewEditContent() {
            const content = document.getElementById('edit-content').value;
            if (!content.trim()) return;
            
            try {
                const response = await fetch('/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });
                
                const html = await response.text();
                document.getElementById('edit-preview-content').innerHTML = html;
                document.getElementById('edit-preview-container').style.display = 'block';
            } catch (error) {
                console.error('Error previewing content:', error);
            }
        }

        // Edit post function
        async function editPost(slug) {
            try {
                const response = await fetch(`/posts/${slug}`);
                const html = await response.text();
                
                // Extract title and content from the response
                const titleMatch = html.match(/<h1[^>]*>([^<]+)<\/h1>/);
                const contentMatch = html.match(/<div class="post-content">([\s\S]*?)<\/div>/);
                
                if (titleMatch && contentMatch) {
                    document.getElementById('edit-title').value = titleMatch[1];
                    document.getElementById('edit-content').value = contentMatch[1];
                    
                    // Set up the form action
                    const form = document.getElementById('edit-post-form');
                    form.setAttribute('hx-put', `/admin/edit/${slug}`);
                    form.setAttribute('hx-target', '#posts-container');
                    
                    document.getElementById('edit-post-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading post for editing:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // HTMX event handlers
        document.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.xhr.status === 200) {
                const response = JSON.parse(event.detail.xhr.responseText);
                if (response.success) {
                    // Refresh the posts list
                    htmx.trigger('#posts-container', 'load');
                    closeModal('new-post-modal');
                    alert('Post created successfully!');
                } else {
                    alert('Error creating post: ' + response.message);
                }
            } else {
                alert('Error creating post. Please try again.');
            }
        });
    </script>
</body>
</html>
